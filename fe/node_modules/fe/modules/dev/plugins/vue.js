const { join } = require('path')
const { Nuxt, Builder } = require('nuxt')
const { inline } = require('../../../utils/console')

module.exports = async runtime => {
  const sharedConfigPath = runtime.ENV.sharedConfigPath
  // Keep nuxt context to avoid calling build() method multiple times when dev:true
  // TODO: should find a better way
  const nuxt = new Nuxt(
    require('../../../utils/mergeConfigFile')(
      'plugins/nuxt.config.js',
      'nuxt.config.js',
      runtime
    )
  )

  // Start fitst build
  await new Builder(nuxt).build().catch(err => inline.error(err))

  return async (app, opts) => {
    // Usage
    // app.ssr.render(req.req, res.res, '/about', req.query, opts.next || {})
    app.decorate('ssr', nuxt)

    // Use `hide` for hide the route from the documentation
    app.get('*', { schema: { hide: true } }, (req, res) => {
      nuxt.render(
        Object.assign(req.req, {
          _req: req
        }),
        Object.assign(res.res, {
          _res: res
        })
      )
    })
  }
}
