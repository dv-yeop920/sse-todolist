const { join } = require('path')
const { inline } = require('../../../utils/console')
module.exports = async runtime => {
  const sharedConfigPath = runtime.ENV.sharedConfigPath
  // Keep nuxt context to avoid calling build() method multiple times when dev:true
  // TODO: should find a better way
  const conf = require('../../../utils/mergeConfigFile')(
    'plugins/next.config.js',
    'next.config.js',
    runtime
  )
  const next = require('next')({
    dir: conf.srcDir,
    dev: true,
    quiet: true,
    conf
  })
  const handle = next.getRequestHandler()

  // Start fitst build
  await next.prepare().catch(err => inline.error(err))

  return async (app, opts) => {
    // Usage
    // app.ssr.render(req.req, res.res, '/about', req.query, opts.next || {})
    app.decorate('ssr', next)

    // Use `hide` for hide the route from the documentation
    app.get('*', { schema: { hide: true } }, (req, res) => {
      // next.render(req.req, rep.res)
      handle(
        Object.assign(req.req, {
          _req: req
        }),
        Object.assign(res.res, {
          _res: res
        })
      )
    })
  }
}
