const { Nuxt, Builder } = require('nuxt')
const fp = require('fastify-plugin')
module.exports = fp(async (app, opts) => {
  const { env = {} } = process
  const dev = env.NODE_ENV !== 'production'
  const nuxt = new Nuxt(Object.assign({}, { dev }, opts))
  if (dev) {
    await new Builder(nuxt)
      .build()
      .catch(err => console.log('Nuxt build failed:', err))
  }

  // Force
  // process.env.PORT = SERVER_PORT
  // process.env.HOST = SERVER_IP

  // Usage
  // app.ssr.render(req.req, res.res, '/about', req.query, opts.next || {})
  app.decorate('ssr', nuxt)
  // Instead `app.use(nuxt.render)` for support `fastify-swagger`
  // Use `hide` for hide the route from the documentation
  app.get('*', { schema: { hide: true } }, (req, res) => {
    nuxt.render(
      Object.assign(req.req, {
        _req: req
      }),
      Object.assign(res.res, {
        _res: res
      })
    )
  })
})
