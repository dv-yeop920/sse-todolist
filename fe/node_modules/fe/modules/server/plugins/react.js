const { join } = require('path')
const fp = require('fastify-plugin')
module.exports = fp(async (app, opts) => {
  // console.log(123, opts)
  const { env = {} } = process
  const dev = env.NODE_ENV !== 'production'

  // const sharedConfigPath = runtime.ENV.sharedConfigPath
  // Keep nuxt context to avoid calling build() method multiple times when dev:true
  // TODO: should find a better way
  const next = require('next')({
    dir: opts.srcDir,
    dev,
    quiet: true,
    conf: opts
  })

  const handle = next.getRequestHandler()

  // Start fitst build
  await next.prepare().catch(err => console.log(123, err))

  // Usage
  // app.ssr.render(req.req, res.res, '/about', req.query, opts.next || {})
  app.decorate('ssr', next)

  // Use `hide` for hide the route from the documentation
  app.get('*', { schema: { hide: true } }, (req, res) => {
    handle(
      Object.assign(req.req, {
        _req: req
      }),
      Object.assign(res.res, {
        _res: res
      })
    )
  })
})
