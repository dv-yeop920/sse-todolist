const { URL } = require('url')
const https = require('https')

const needles = [
  'https://registry.npm.taobao.org/fe/latest',
  'https://registry.npmjs.org/fe/latest',
  'https://registry.yarnpkg.com/fe/latest'
]

const race = promises => {
  const resolve = Promise.resolve.bind(Promise)
  const reject = Promise.reject.bind(Promise)
  return Promise.all(promises.map(x => x.then(reject, resolve))).then(
    reject,
    resolve
  )
}

const ping = (url, i) =>
  new Promise((resolve, reject) => {
    const start = Date.now()
    const { hostname, pathname } = new URL(url)
    const req = https.request(
      {
        hostname,
        path: pathname
      },
      () => {
        // process.stdout.write('.')
        // console.log(Date.now() - start)
        resolve(i)
      }
    )
    req.on('error', reject)
    req.end()
  })

module.exports = async () => !await race(needles.map(ping))
